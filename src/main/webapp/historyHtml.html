<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>历史模板</title>
    <link rel="stylesheet" href="js/layui/css/layui.css">
    <script src="js/layui/layui.js"></script>
</head>
<body>
    <div>
        <h2>历史模板</h2>
        <table id="historyHtml" lay-filter="test"></table>

    </div>

    <script type="text/html" id="barDemo">
        <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="preview">预览</a>
        <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="edit">编辑</a>
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
        {{#  if(d.page_status == "yes"){ }}
        <a class="layui-btn layui-btn-warm layui-btn-xs no" lay-event="no">已显示</a>
        {{# }if(d.page_status == "no") { }}
        <a class="layui-btn layui-btn-xs yes" lay-event="yes">显示</a>
        {{#  } }}

    </script>

    <script>
        var $,files;

        layui.use(['jquery','upload','carousel','layer','table'], function() {
            $ = layui.jquery;
            var layer = layui.layer,
                upload = layui.upload,
                table = layui.table;


            //表格查询图片
            var tableIns = table.render({
                elem: '#historyHtml'
                , height: "500px"
                , url: getRootPath() + '/html/searchHistoryHtml' //数据接口
                , page: { //支持传入 laypage 组件的所有参数（某些参数除外，如：jump/elem） - 详见文档
                    layout: ['limit', 'count', 'prev', 'page', 'next', 'skip'] //自定义分页布局
                    //,curr: 5 //设定初始在第 5 页
                    , groups: 3 //只显示 1 个连续页码
                    , first: "首页" //不显示首页
                    , last: "尾页" //不显示尾页
                }
                , cellMinWidth: 80 //全局定义常规单元格的最小宽度，
                , limit: 5
                , limits: [5, 10, 15]
                , id: "#historyHtml"
                , cols: [[ //表头
                    {field: 'page_id', title: 'ID', sort: true, fixed: 'left'}
                    , {field: 'page_name', title: '页面名',}
                    , {field: 'page_src', title: '页面路径',}
                    , {field: 'create_time', title: '创建时间',}
                    , {field: 'page_status', title: '页面状态',}
                    , {fixed: 'right', title: '操作', toolbar: '#barDemo'}
                ]]
            });

            //监听行工具事件
            table.on('tool(test)', function (obj) {
                var data = obj.data;
                //console.log(obj)
                if (obj.event === 'del') {
                    layer.confirm('真的删除行么', function (index) {
                        obj.del();
                        layer.close(index);
                        //后台操作
                        $.ajax({
                            url: getRootPath() + "/html/delHtml",
                            type: "get",
                            data: {"page_id": data.page_id, "page_src": data.page_src},
                            datatype: "json",
                            success: function (data) {
                            }
                        });

                    });
                } else if (obj.event === 'edit') {
                    layer.prompt({
                        title: "输入跳转链接,外网链接以 https:// 开头"
                        , formType: 3
                        , value: data.img_href
                    }, function (value, index) {
                        obj.update({
                            img_href: value
                        });
                        layer.close(index);
                        //后台操作
                        $.ajax({
                            url: getRootPath() + "/html/updataImg_href",
                            type: "get",
                            data: {"img_href": value, "img_id": data.img_id},
                            success: function () {
                            }
                        });
                    });
                } else if (obj.event === 'yes') {
                    obj.update({
                        img_status: "yes"
                    });
                    //后台操作
                    $.ajax({
                        url: getRootPath() + "/html/updataImg_status",
                        type: "get",
                        data: {"img_status": "yes", "img_id": obj.data.img_id},
                        success: function () {
                            tableIns.reload()
                        }
                    });
                } else if (obj.event === 'no') {
                    obj.update({
                        img_status: "no"
                    });
                    //后台操作
                    $.ajax({
                        url: getRootPath() + "/html/updataImg_status",
                        type: "get",
                        data: {"img_status": "no", "img_id": obj.data.img_id},
                        success: function () {
                            tableIns.reload()
                        }
                    });
                } else if (obj.event === 'preview') {
                    layer.open({
                        type: 2,
                        title: 'layer mobile页',
                        shadeClose: true,
                        shade: 0.8,
                        area: ['380px', '90%'],
                        content: getRootPath()+"/"+data.page_src //iframe的url
                    });
                }
            });
        });
        var getRootPath = function() {
            // http://localhost:8083/uimcardprj/share/meun.jsp
            var curWwwPath = window.document.location.href;
            // uimcardprj/share/meun.jsp
            var pathName = window.document.location.pathname;
            var pos = curWwwPath.indexOf(pathName);
            // http://localhost:8083
            var localhostPaht = curWwwPath.substring(0, pos);
            // uimcardprj
            var projectName = pathName
                .substring(0, pathName.substr(1).indexOf('/') + 1);
            if (projectName == "/weixin" || projectName == "/admin"  || projectName == "/pc")
                projectName = "";
            return(localhostPaht + projectName);
        }
    </script>
</body>
</html>